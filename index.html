<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TCSS 142 · Project 2 Tester</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b1020;
      --ink:#eaf0ff;
      --muted:#b5bfdd;
      --panel:rgba(255,255,255,.05);
      --panel-border:rgba(255,255,255,.12);
      --accent:#8d9cff;
      --accent-2:#a67aff;
      --ok:#2bd67b;
      --warn:#ffcc4d;
      --err:#ff5d5d;
      --code-bg:#101528;
      --code-fg:#e6ebff;
      --radius:16px;
      --shadow:0 16px 40px rgba(0,0,0,.35);
      --loader-speed:1.3s;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 80% -20%, rgba(122,162,255,.25), transparent 60%),
        radial-gradient(900px 700px at -10% 20%, rgba(159,122,255,.25), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }

    .hero{ text-align:center; padding:60px 20px 20px }
    .title{
      display:inline-block; padding:8px 16px; margin-bottom:10px;
      border-radius:999px; border:1px solid var(--panel-border);
      font-size:12px; background:rgba(255,255,255,.08); backdrop-filter:blur(6px)
    }
    h1{ margin:14px 0 8px; font-size:clamp(28px,4vw,44px) }
    .grad{ background:linear-gradient(90deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; color:transparent; font-weight:800 }
    .credit{ color:var(--muted); font-size:13px }

    .wrap{ max-width:1100px; margin:auto; padding:20px; display:grid; gap:20px }
    .card{ background:var(--panel); border:1px solid var(--panel-border); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter:blur(10px); overflow:hidden }
    .section-head{ display:flex; justify-content:space-between; align-items:center; padding:16px 18px 0 }
    .section-head b{ font-size:14px }
    .tbtn{ padding:6px 10px; font-size:12px; border:1px solid var(--panel-border); border-radius:8px; background:rgba(255,255,255,.06); color:var(--ink); cursor:pointer }
    .tbtn:hover{ filter:brightness(1.08) }

    .codebox{ display:grid; grid-template-columns:auto 1fr; border-top:1px solid var(--panel-border); border-bottom:1px solid var(--panel-border) }
    .gutter{
      background:rgba(255,255,255,.04);
      border-right:1px solid var(--panel-border);
      padding:12px 8px;
      text-align:right;
      color:#93a2c8;
      user-select:none;
      white-space:pre;
      overflow:hidden;
      font:12px/1.55 ui-monospace,monospace;
      min-width:42px;
    }
    textarea{
      width:100%; min-height:420px; resize:vertical;
      padding:12px 14px;
      background:var(--code-bg); color:var(--code-fg);
      border:0; outline:none;
      font:13.5px/1.55 ui-monospace,monospace;
      white-space:pre;             /* no soft wrap */
      overflow-wrap:normal;
    }

    .bar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; padding:12px 14px }
    .btn{
      border:0; border-radius:10px; padding:10px 16px;
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#fff; font-weight:600; cursor:pointer
    }
    .btn.secondary{ background:rgba(255,255,255,.08); color:var(--ink); border:1px solid var(--panel-border) }

    .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; font-size:12px; border:1px solid var(--panel-border); border-radius:10px; background:rgba(255,255,255,.06) }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--muted) }
    .dot.ok{ background:var(--ok) } .dot.warn{ background:var(--warn) } .dot.err{ background:var(--err) }

    .meter{ position:relative; flex:1; min-width:120px; height:6px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,.08) }
    .meter .fill{
      position:absolute; inset:0;
      width:38%;
      opacity:.9;
      border-radius:999px;
      background:
        linear-gradient(90deg,
          rgba(255,255,255,.0) 0%,
          rgba(255,255,255,.25) 35%,
          rgba(255,255,255,.0) 70%) ,
        linear-gradient(90deg,var(--accent),var(--accent-2));
      background-size:220% 100%, 100% 100%;
      background-position:-200% 0, 0 0;
      animation: shimmer var(--loader-speed) linear infinite;
      animation-play-state: paused;
      transform: translateX(-120%);
    }
    .meter.running .fill{ animation-play-state: running; transform: translateX(0) }
    @keyframes shimmer{
      0%   { background-position:-200% 0, 0 0 }
      100% { background-position:  200% 0, 0 0 }
    }
    @media (prefers-reduced-motion: reduce){
      .meter .fill{ animation:none; background:linear-gradient(90deg,var(--accent),var(--accent-2)); opacity:.6 }
      .meter.running .fill{ opacity:.95 }
    }

    .meta{ font-size:12px; color:var(--muted) }

    .console{ padding:14px }
    .screen{
      background:var(--code-bg); color:var(--code-fg);
      border:1px solid rgba(255,255,255,.1);
      border-radius:10px; padding:14px; min-height:120px;
      font:13.5px/1.55 ui-monospace,monospace; white-space:pre-wrap
    }

    footer{ max-width:1100px; margin:40px auto; padding:0 20px; color:var(--muted); font-size:14px }
    .foot-card{ background:rgba(255,255,255,.04); border:1px solid var(--panel-border); border-radius:12px; padding:14px 16px; display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px }
    a{ color:var(--accent); text-decoration:none } a:hover{ text-decoration:underline }

    .kbd{ font:12px/1; padding:4px 6px; border-radius:6px; background:rgba(255,255,255,.08); border:1px solid var(--panel-border) }
    .shortcuts{ display:grid; gap:6px; font-size:12px; margin-top:10px }
  </style>
</head>
<body>
  <div class="hero">
    <div class="title">SurgeTester</div>
    <h1><span class="grad">TCSS 142</span> Project 2 Tester</h1>
    <p>Paste <b>SurgeSimulator.java</b> to run automated correctness and boundary tests.</p>
    <p class="credit">Instructor: Professor Xutong Liu · TA: Faiz Ahmed</p>
  </div>

  <main class="wrap">
    <section class="card">
      <div class="section-head">
        <b>Editor</b>
        <div class="tools">
          <button class="tbtn" id="exampleBtn">Insert template</button>
        </div>
      </div>

      <div class="codebox">
        <div class="gutter" id="gutter">1</div>
        <textarea id="code" spellcheck="false" placeholder="Paste your SurgeSimulator.java here..."></textarea>
      </div>

      <div class="bar">
        <button class="btn" id="runBtn">Run Tests</button>
        <button class="btn secondary" id="clearBtn">Clear</button>

        <span class="chip"><i class="dot" id="dot"></i><span id="statusText">Idle</span></span>

        <div class="meter" id="meter"><div class="fill"></div></div>

        <span class="meta" id="lenMeta"></span>
      </div>
    </section>

    <section class="card console">
      <div class="section-head" style="padding:0 0 10px 0;">
        <b>Output</b><span class="meta">Shows the last run</span>
      </div>
      <div class="screen" id="out">Waiting for input…</div>
    </section>
  </main>

  <footer>
    <div class="foot-card">
      <div>
        Need help? Contact <b>Faiz Ahmed</b> (<a href="mailto:faizahm@uw.edu">faizahm@uw.edu</a>)
        <div class="shortcuts">
          <div><span class="kbd">Ctrl</span>/<span class="kbd">Cmd</span> + <span class="kbd">Enter</span> — run tests</div>
          <div><span class="kbd">Esc</span> — clear code and output • <span class="kbd">Shift</span> + <span class="kbd">Esc</span> — clear output only</div>
          <div><span class="kbd">Ctrl</span>/<span class="kbd">Cmd</span> + <span class="kbd">I</span> — insert template • <span class="kbd">Ctrl</span>/<span class="kbd">Cmd</span> + <span class="kbd">L</span> — clear</div>
          <div><span class="kbd">Ctrl</span>/<span class="kbd">Cmd</span> + <span class="kbd">S</span> — save to browser • <span class="kbd">Ctrl</span>/<span class="kbd">Cmd</span> + <span class="kbd">O</span> — load</div>
        </div>
      </div>
      <div>If tests hang, check for infinite loops or very heavy printing.</div>
    </div>
  </footer>

  <script>
    const codeEl   = document.getElementById("code");
    const gutter   = document.getElementById("gutter");
    const runBtn   = document.getElementById("runBtn");
    const clearBtn = document.getElementById("clearBtn");
    const out      = document.getElementById("out");
    const statusTx = document.getElementById("statusText");
    const dot      = document.getElementById("dot");
    const lenMeta  = document.getElementById("lenMeta");
    const example  = document.getElementById("exampleBtn");
    const meter    = document.getElementById("meter");
    const LS_KEY   = "tcss142_p2_surgesim_code";

    // --- Utils ---
    function setStatus(kind, text){
      statusTx.textContent = text;
      dot.className = "dot " + (kind || "");
    }
    function updateGutter(){
      const lines = (codeEl.value.match(/\n/g)||[]).length + 1;
      let s = "";
      for(let i=1;i<=lines;i++) s += i + "\n";
      gutter.textContent = s;
      gutter.scrollTop = codeEl.scrollTop;
    }
    function updateLen(){
      const bytes = new TextEncoder().encode(codeEl.value).length;
      lenMeta.textContent = bytes ? `Size: ${bytes.toLocaleString()} bytes` : "";
    }
    function setRunning(on){
      if(on) meter.classList.add("running");
      else   meter.classList.remove("running");
    }
    function clearAll(){
      if(codeEl.value.trim()){
        const ok = confirm("Clear editor and output?");
        if(!ok) return;
      }
      codeEl.value = "";
      updateGutter(); updateLen();
      out.textContent = "Waiting for input…";
      setStatus("", "Idle");
      setRunning(false);
      saveToLS();
    }
    function clearOutputOnly(){
      out.textContent = "Waiting for input…";
      setStatus("", "Idle");
      setRunning(false);
    }
    function insertTemplate(){
      const tpl = `public class SurgeSimulator {
}`;
      if(codeEl.value.trim() && !confirm("Replace existing code with a template?")) return;
      codeEl.value = tpl;
      updateGutter(); updateLen();
      saveToLS();
    }
    async function runTests(){
      const code = codeEl.value.trim();
      if(!code){
        setStatus("warn","No code");
        out.textContent = "Paste your SurgeSimulator.java first.";
        return;
      }
      setStatus("warn","Running"); setRunning(true);
      out.textContent = "Compiling and running…";
      saveToLS();

      try{
        const res  = await fetch("/run", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({ code })
        });
        const text = await res.text();
        out.textContent = text;

        if (text.includes("All checks passed")) setStatus("ok","All checks passed");
        else if (text.includes("Compilation failed")) setStatus("err","Compilation failed");
        else if (text.toLowerCase().includes("timed out")) setStatus("warn","Timed out");
        else setStatus("warn","Completed");
      }catch{
        out.textContent = "Network error.";
        setStatus("err","Network error");
      }finally{
        setRunning(false);
      }
    }

    // Local Storage
    function saveToLS(){ try{ localStorage.setItem(LS_KEY, codeEl.value) }catch{} }
    function loadFromLS(){
      try{
        const v = localStorage.getItem(LS_KEY);
        if(v != null){ codeEl.value = v; updateGutter(); updateLen(); }
      }catch{}
    }

    // --- Events ---
    codeEl.addEventListener("input",()=>{ updateGutter(); updateLen(); saveToLS(); });
    codeEl.addEventListener("scroll",()=>{ gutter.scrollTop = codeEl.scrollTop; });
    clearBtn.addEventListener("click",clearAll);
    example.addEventListener("click",insertTemplate);
    runBtn.addEventListener("click",runTests);

    // Keyboard shortcuts (Windows/Linux Ctrl, macOS Cmd)
    window.addEventListener("keydown", (e)=>{
      const mod = e.ctrlKey || e.metaKey;

      // Run: Ctrl/Cmd + Enter
      if(mod && e.key === "Enter"){
        e.preventDefault(); runTests(); return;
      }
      // Clear: Esc, or Ctrl/Cmd + L
      if(e.key === "Escape" && !e.shiftKey){
        e.preventDefault(); clearAll(); return;
      }
      if(mod && (e.key.toLowerCase() === "l")){
        e.preventDefault(); clearAll(); return;
      }
      // Clear output only: Shift + Esc
      if(e.key === "Escape" && e.shiftKey){
        e.preventDefault(); clearOutputOnly(); return;
      }
      // Insert template: Ctrl/Cmd + I
      if(mod && e.key.toLowerCase() === "i"){
        e.preventDefault(); insertTemplate(); return;
      }
      // Save: Ctrl/Cmd + S
      if(mod && e.key.toLowerCase() === "s"){
        e.preventDefault(); saveToLS(); setStatus("ok","Saved"); return;
      }
      // Load: Ctrl/Cmd + O
      if(mod && e.key.toLowerCase() === "o"){
        e.preventDefault(); loadFromLS(); setStatus("ok","Loaded"); return;
      }
      // No Ctrl/Cmd + W binding to avoid closing tab
    });

    // Init
    loadFromLS();
    updateGutter(); updateLen(); setRunning(false);
  </script>
</body>
</html>
